<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
<meta property="og:type" content="website">
<meta property="og:title" content="牛牛的小窝">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="牛牛的小窝">
<meta property="og:description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="niuniu">
<meta property="article:tag" content="Java, Mysql, Linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>牛牛的小窝</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">牛牛的小窝</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不奢望岁月静好 只希望点滴积累</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_mq%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_mq%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">mq何时使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li>异步处理</li>
<li>流量控制(令牌桶)</li>
<li>服务解耦</li>
</ul>
<p><strong>局限</strong></p>
<ul>
<li>增加系统复杂度</li>
<li>增加部分延迟</li>
<li>可能导致数据不一致</li>
</ul>
<p><strong>思考</strong></p>
<ol>
<li>CPU的运算速度 远大于 内存读写速度 –&gt; CPU缓存(L1 &#x2F; L2 &#x2F; L3)</li>
<li>内存的读写速度 远大于 硬盘 –&gt; 内存缓存系统 (redis &#x2F; memcache 等) 和 本地缓存 、线程缓存</li>
<li>上游系统的处理速度大于下游依赖系统 –&gt; mq(缓存上游请求)</li>
<li>网络请求、磁盘操作比较耗时 –&gt; 出现了缓存系统 &#x2F; 协程 &#x2F; 多线程等概念来解决</li>
<li>CPU写内存的速度小于写cache -&gt; 先写cache、定时刷新 -&gt; 出现了线程同步问题</li>
<li>写内存的速度大于写磁盘 –&gt; redis 、mysql等系统应用的日志都是先写cache、按照指定规则刷新 –&gt; 有了系统崩溃短时间内log不能恢复的问题</li>
<li>生产者和消费者速度不一致 –&gt; 有了broker暂存消息</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mongo_%E7%B4%A2%E5%BC%95%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mongo_%E7%B4%A2%E5%BC%95%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">索引简单使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mongo/" itemprop="url" rel="index"><span itemprop="name">Mongo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>###索引管理</p>
<h4 id="索引创建"><a href="#索引创建" class="headerlink" title="索引创建"></a>索引创建</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.ensureIndex(keys[,<span class="keyword">options</span>])</span><br><span class="line"></span><br><span class="line">keys: 要建立索引的参数列表 key字段名、<span class="number">1</span>升序 <span class="number">-1</span>降序</span><br><span class="line"></span><br><span class="line"><span class="keyword">options</span>: 可选参数</span><br><span class="line">background: <span class="type">Boolean</span> 在后台建立索引</span><br><span class="line"><span class="keyword">unique</span>: <span class="type">boolean</span> 创建唯一索引、默认<span class="keyword">false</span></span><br><span class="line"><span class="type">name</span> String指定索引名称</span><br><span class="line">dropDups <span class="type">Boolean</span>创建唯一索引时、若若出现重复、删除后续出现的相同索引、只保留第一个</span><br><span class="line">sparse <span class="type">Boolean</span> 对文档中不存在的字段数据不启用索引、默认<span class="keyword">false</span></span><br><span class="line">v <span class="keyword">index</span> <span class="keyword">version</span> 索引的版本号</span><br><span class="line">weights document索引权重值、表示改索引相对其它索引字段的得分权重值</span><br></pre></td></tr></table></figure>

<h4 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.collectionName</span><span class="selector-class">.reIndex</span>()</span><br><span class="line">作用类似于mysql的optimize、修复多次修改产生的文件空洞</span><br></pre></td></tr></table></figure>

<h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.collectionName</span><span class="selector-class">.getIndexes</span>()</span><br><span class="line">查看索引大小</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.collectionName.<span class="keyword">drop</span>Index(IndexName)</span><br><span class="line"></span><br><span class="line">删除所有索引</span><br><span class="line">db.collectionName.<span class="keyword">drop</span>Indexes;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="基础索引与复合索引"><a href="#基础索引与复合索引" class="headerlink" title="基础索引与复合索引"></a>基础索引与复合索引</h3><h4 id="基础索引"><a href="#基础索引" class="headerlink" title="基础索引"></a>基础索引</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 为一个集合中的某个字段创建索引</span><br><span class="line">eg. db<span class="selector-class">.useers</span><span class="selector-class">.ensureIndex</span>(&#123;age:<span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 当数据很多时、索引创建会比较慢、可以指定 <span class="attribute">background</span>: true</span><br><span class="line">eg. db.users.<span class="built_in">ensureIndex</span>(&#123;age:<span class="number">1</span>&#125;, &#123;<span class="attribute">background</span>: true&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">为users表的age和city字段、创建联合索引、分表按照升序和降序排列</span><br><span class="line">eg. db.useers.ensure<span class="constructor">Index(&#123;<span class="params">age</span>:1, <span class="params">city</span>:-1&#125;)</span></span><br></pre></td></tr></table></figure>

<h4 id="查看索引-1"><a href="#查看索引-1" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db<span class="selector-class">.dbname</span><span class="selector-class">.getIndexes</span>() 返回当前集合所有的索引</span><br><span class="line"><span class="number">1</span>:升序  -<span class="number">1</span>:降序</span><br></pre></td></tr></table></figure>

<h3 id="文档索引"><a href="#文档索引" class="headerlink" title="文档索引"></a>文档索引</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. mongodb可以为多个字段创建索引、当字段是子文档时、同样可以创建</span><br><span class="line">eg. mongo中有下列数据</span><br><span class="line">&#123;name:<span class="string">&quot;aaa&quot;</span>, address:&#123;city:<span class="string">&quot;bj&quot;</span>,district:<span class="string">&quot;海淀&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">可以为<span class="selector-tag">address</span>创建索引如下:</span><br><span class="line">db.users.<span class="built_in">ensureIndex</span>(&#123;<span class="selector-tag">address</span>:<span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">建立索引后、查询时子文档的字段顺序要和查询顺序一致、才可使用索引</span><br><span class="line"></span><br><span class="line">// 会使用索引</span><br><span class="line">db<span class="selector-class">.users</span><span class="selector-class">.find</span>(&#123;<span class="selector-tag">address</span>:&#123;city:<span class="string">&quot;bj&quot;</span>,district:<span class="string">&quot;海淀&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">// 不会使用索引</span><br><span class="line">db<span class="selector-class">.users</span><span class="selector-class">.find</span>(&#123;<span class="selector-tag">address</span>:&#123;district:<span class="string">&quot;海淀&quot;</span>,city:<span class="string">&quot;bj&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">也可以只对子文档的某一个或者部分字段创建索引</span><br><span class="line">db<span class="selector-class">.users</span><span class="selector-class">.ensureIndex</span>(&#123;&quot;<span class="selector-tag">address</span><span class="selector-class">.city</span>&quot;:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="唯一索引与强制索引"><a href="#唯一索引与强制索引" class="headerlink" title="唯一索引与强制索引"></a>唯一索引与强制索引</h3><h4 id="创建唯一索引"><a href="#创建唯一索引" class="headerlink" title="创建唯一索引"></a>创建唯一索引</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">添加索引时、指定 unique:<span class="literal">true</span> 等效于唯一索引</span><br><span class="line">eg. 为users表的email字段添加唯一索引</span><br><span class="line">db.users.ensure<span class="constructor">Index(&#123;<span class="params">email</span>:1&#125;,&#123;<span class="params">unique</span>:<span class="params">true</span>&#125;)</span></span><br><span class="line"></span><br><span class="line">创建唯一索引后、插入重复值时、mongo会报错..</span><br></pre></td></tr></table></figure>

<h4 id="强制使用索引"><a href="#强制使用索引" class="headerlink" title="强制使用索引"></a>强制使用索引</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.users.<span class="title function_ invoke__">find</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;aaa&#x27;</span>, <span class="attr">age</span>:<span class="number">3</span>&#125;).<span class="title function_ invoke__">hint</span>(&#123;<span class="attr">age</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_mq%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_mq%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">mq本地搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>启动:<br>进入到编译target目录<br>eg. 我的下载路径是 &#x2F;Users&#x2F;nj&#x2F;build&#x2F;rocketmq-all-4.4.0<br>cd &#x2F;Users&#x2F;nj&#x2F;build&#x2F;rocketmq-all-4.4.0&#x2F;distribution&#x2F;target&#x2F;apache-rocketmq&#x2F;</p>
<p>1.启动namesrv<br>sh bin&#x2F;mqnamesrv &amp;</p>
<ol start="2">
<li><p>启动broker<br>sh bin&#x2F;mqbroker &amp;</p>
</li>
<li><p>测试:<br>sh bin&#x2F;tools.sh org.apache.rocketmq.example.quickstart.Producer<br>报错:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">28</span>:<span class="number">23.123</span> <span class="selector-attr">[main]</span> DEBUG <span class="selector-tag">i</span><span class="selector-class">.n</span><span class="selector-class">.u</span><span class="selector-class">.i</span><span class="selector-class">.l</span><span class="selector-class">.InternalLoggerFactory</span> - Using SLF4J as the default logging framework</span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.client</span><span class="selector-class">.exception</span><span class="selector-class">.MQClientException</span>: No route info of this topic, TopicTest1</span><br><span class="line">See http:<span class="comment">//rocketmq.apache.org/docs/faq/ for further details.</span></span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.client</span><span class="selector-class">.impl</span><span class="selector-class">.producer</span><span class="selector-class">.DefaultMQProducerImpl</span><span class="selector-class">.sendDefaultImpl</span>(DefaultMQProducerImpl<span class="selector-class">.java</span>:<span class="number">610</span>)</span><br><span class="line"><span class="number">17</span>:<span class="number">28</span>:<span class="number">29.595</span> <span class="selector-attr">[NettyClientSelector_1]</span> INFO  RocketmqRemoting - closeChannel: close the connection to remote <span class="selector-tag">address</span><span class="selector-attr">[]</span> result: true</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.client</span><span class="selector-class">.impl</span><span class="selector-class">.producer</span><span class="selector-class">.DefaultMQProducerImpl</span><span class="selector-class">.send</span>(DefaultMQProducerImpl<span class="selector-class">.java</span>:<span class="number">1223</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.client</span><span class="selector-class">.impl</span><span class="selector-class">.producer</span><span class="selector-class">.DefaultMQProducerImpl</span><span class="selector-class">.send</span>(DefaultMQProducerImpl<span class="selector-class">.java</span>:<span class="number">1173</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.rocketmq</span><span class="selector-class">.client</span><span class="selector-class">.producer</span><span class="selector-class">.DefaultMQProducer</span><span class="selector-class">.send</span>(DefaultMQProducer<span class="selector-class">.java</span>:<span class="number">214</span>)</span><br><span class="line">	at com<span class="selector-class">.lct</span><span class="selector-class">.quickstart</span><span class="selector-class">.Producer</span><span class="selector-class">.main</span>(Producer<span class="selector-class">.java</span>:<span class="number">56</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke0</span>(Native Method)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.NativeMethodAccessorImpl</span><span class="selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">62</span>)</span><br><span class="line">	at sun<span class="selector-class">.reflect</span><span class="selector-class">.DelegatingMethodAccessorImpl</span><span class="selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Method<span class="selector-class">.java</span>:<span class="number">498</span>)</span><br><span class="line">	at com<span class="selector-class">.intellij</span><span class="selector-class">.rt</span><span class="selector-class">.execution</span><span class="selector-class">.application</span><span class="selector-class">.AppMain</span><span class="selector-class">.main</span>(AppMain<span class="selector-class">.java</span>:<span class="number">140</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>原因:<br>mac本地搭建使用VPN时、会有两个内网ip、用telnet找到可以访问的那个、<br>修改broker.conf<br>指定brokerIP的地址:<br>brokerIP1 &#x3D; 192.168.10.54<br>brokerIP2 &#x3D; 192.168.10.54</p>
<p>查看broker启动参数:<br>sh bin&#x2F;mqbroker -m</p>
<p>mqAdmin使用:<br>####查看集群情况<br>.&#x2F;mqadmin clusterList -n 127.0.0.1:9876</p>
<p>####查看broker状态<br>.&#x2F;mqadmin brokerStatus -n 127.0.0.1:9876 -b 192.168.10.54:10911</p>
<p>####查看topic列表<br>.&#x2F;mqadmin topicList -n 192.168.10.54:9876</p>
<p>####查看topic状态<br>.&#x2F;mqadmin topicStatus -n 127.0.0.1:9876 -t PushTopic</p>
<p>####查看topic路由<br>.&#x2F;mqadmin topicRoute -n 127.0.0.1:9876 -t PushTopic</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_mq%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_mq%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">mq网络传输模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>实现通过网络来传输数据、需要网络通信类库, 大部分网络通信基础类库都是同步的. 一个TCP连接建立后、用户代码会得到用于收发数据的通道、每个通道会在内存开辟两片区域用于收发数据的缓存</p>
<p>发数据比较简单:<br>用户代码在发送时写入的数据会暂存在缓存中、然后操作系统会通过网卡、把发送缓存中的数据传输到对端的服务器上<br>       只要缓存不满、或者发送数据的速度未超过网卡传输速度的上限、发送数据的操作耗时就只是写入一次内存的时间、同步发送即可、无需异步</p>
<p>接收数据比较麻烦、它不知道什么时候会收到数据<br><code>同步IO</code>: 用一个线程阻塞、等待数据、数据到来、操作系统会先把数据写入到接收缓存、然后给接收数据的线程发通知、接收线程收到通知结束等待、开始读取数据、处理完将继续阻塞、等待下次数据到来<br><img src="https://upload-images.jianshu.io/upload_images/14027542-31618a43c52ff67d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>同步IO处理少量连接没问题、但同时处理大量连接的时候、每个连接都会阻塞一个线程来等待数据、这些连接都在收发数据的时候就会有大量的线程来抢占CPU的世界、造成频繁的CPU上下文切换、导致CPU的负载升高、系统性能下降</p>
<p>期望值:<br>事先定义好收到数据后的处理逻辑、将它作为一个回调方法、收到数据后、网络通信框架直接回调这个方法就好</p>
<h4 id="Java网络模型"><a href="#Java网络模型" class="headerlink" title="Java网络模型"></a>Java网络模型</h4><p>极客时间留言区看到一个很不错的评论、收藏下<br>举例: 有一个养鸡的农场、里边养着各个农户Thread的鸡Socket、每个农户都在农场中建立了自己的鸡舍SocketCahnnel</p>
<ol>
<li><code>BIO</code>: Bolck IO, 每个农户盯着自己的鸡舍、有下蛋、就去捡</li>
<li><code>NIO</code>: No-Block IO, 单 Selector、农户们花钱请了一个饲养员 <code>Selector</code>, 并且告诉饲养员Register 若哪家的鸡下蛋要向农户报告 select keys</li>
<li><code>NIO</code>: No-Block IO - 多Selector、鸡舍增多时、一个饲养员巡视(轮询)一次的时间增大、延迟较大、多请几个、每个饲养员分配几个鸡舍管理、减小延迟</li>
<li><code>epoll</code>: 饲养员不巡查鸡舍、听到有鸡打鸣(活跃连接)就知道下单了</li>
<li><code>AIO</code>: Asynchronous IO、鸡下单后、饲养员负责取蛋、通知农户来取即可、不需要农户自己到鸡舍取蛋</li>
</ol>
<h4 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h4><p>TCP连接上、传输数据的基本形式是二进制流、0和1、在一般编程语言或者框架提供的api中、传输数据的基本形式是字节Byte、本质上是二进制流</p>
<p>编写的程序是结构化的数据, eg. 类或者结构体<br><strong>显然, 要使用网络框架的API来传输结构化的数据、必须先实现结构化的数据和字节流之间的双向转换</strong></p>
<p>文件内保存数据的形式也是二进制序列、所以、也需要序列化结构化数据才能实现</p>
<h4 id="如何选择序列化方式"><a href="#如何选择序列化方式" class="headerlink" title="如何选择序列化方式"></a>如何选择序列化方式</h4><p>需要权衡的因素:</p>
<ul>
<li>序列化后的数据易于阅读</li>
<li>实现复杂度低</li>
<li>序列化和发序列化越快越好</li>
<li>序列化后的信息密度越大越好、即同一个结构化刷数据、序列化后占用的空间越小越好</li>
</ul>
<p>而 1和4 是矛盾的、2 和 3是矛盾的、所以需要根据业务场景合理选择</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>在内存中存放的数据、最基础的存储单元也是二进制比特、也就是说应用程序操作的对象、在内存中也是使用二进制存储的、既然都是二进制、为什么不直接把二进制数据通过网络发送出去 ？</p>
<p>内存里的内容、不通用、不同系统不同语言的组织可能都是不一样的、而且存在很多引用、指针、并不是直接数据块<br>序列化、反序列化其实是约定一种标准、大家都遵守就能实现跨语言、跨平台</p>
<h4 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h4><p><strong>高并发下的内存管理技巧</strong></p>
<ol>
<li><p>优化代码中处理请求的业务逻辑、减少创建一次性对象、eg. 可以将受到请求的Request对象在业务流程中尽量传递下去、而不是执行一个步骤就创建一个内容和Request对象差不多的新对象</p>
</li>
<li><p>使用频繁的对象、可以考虑建立一个对象池、收到请求后在对象池内申请一个对象、使用完放回对象池</p>
</li>
<li><p>可能的话、直接使用更大内存的服务器、也可以非常有效的缓解这个问题</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_rocketMQ%E5%AE%9E%E4%BE%8B%E4%B8%8A%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_rocketMQ%E5%AE%9E%E4%BE%8B%E4%B8%8A%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">rocketMQ实例上的定时任务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 120s更新一次nameSrv地址表</span><br><span class="line"><span class="bullet">2.</span> 30s或指定配置时间pollNameServerInterval 更新一次 topic路由信息</span><br><span class="line"><span class="bullet">3.</span> 30s或指定时间 heartbeatBrokerInterval 更新一次broker信息</span><br><span class="line"><span class="bullet">4.</span> 5s或persistConsumerOffsetInterval时间、持久化一次消费偏移量信息</span><br><span class="line"><span class="bullet">5.</span> 每分钟动态调整一个threadpool大小</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_rocketMQ%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_rocketMQ%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/" class="post-title-link" itemprop="url">rocketMQ消息存储</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rocketmq消息格式</span><br><span class="line"><span class="symbol">totalSize:</span> 消息长度、<span class="number">4</span>字节</span><br><span class="line"><span class="symbol">magicCode:</span> 魔术 <span class="number">4</span>字节</span><br><span class="line"><span class="symbol">bodycrc:</span> 消息体crc校验码 <span class="number">4</span>字节</span><br><span class="line"><span class="symbol">queueId:</span> 消息队列id <span class="number">4</span>字节</span><br><span class="line"><span class="symbol">flag:</span> 消息flag、mq不处理、</span><br><span class="line"><span class="symbol">ququeoffset:</span> 消息在队列中的偏移量</span><br><span class="line"><span class="symbol">physicaloffset:</span> 消息在commitlog中的偏移量</span><br><span class="line"><span class="symbol">sysflag:</span> 消息系统flag、eg 是否压缩、是否是事务消息等 <span class="number">4</span>字节</span><br><span class="line"><span class="symbol">bronTimeStamp:</span> 生产者调用消息发送API时的时间戳 <span class="number">8</span>字节</span><br><span class="line"><span class="symbol">bornHost:</span> 消息发送者ip、端口 <span class="number">8</span>字节</span><br><span class="line"><span class="symbol">storeTimeStamp:</span> 消息存储时间戳  <span class="number">8</span>字节</span><br><span class="line"><span class="symbol">storeHostAddress:</span> broker服务器ip+port <span class="number">8</span>字节</span><br><span class="line"><span class="symbol">reconsumetimes:</span> 消息重试次数 <span class="number">4</span>字节</span><br><span class="line"><span class="symbol">bodylength:</span> 消息长度</span><br><span class="line"><span class="symbol">body:</span> 消息内容</span><br><span class="line"><span class="symbol">topicLength:</span> 主题存储长度</span><br><span class="line"><span class="symbol">topic:</span> 主题</span><br><span class="line"><span class="symbol">propertiesLength:</span> 消息属性长度、<span class="number">2</span>字节</span><br><span class="line"><span class="symbol">Properties:</span> 消息属性</span><br></pre></td></tr></table></figure>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1.</span> 存储设计</span><br><span class="line">   commitLog: 消息存储文件、所有topic的消息都存储在commitLog</span><br><span class="line">   大小默认<span class="number">1</span>G、以文件中第一个偏移量为文件名、偏移量小于<span class="number">20</span>位、用<span class="number">0</span>补全</span><br><span class="line">   </span><br><span class="line">   consumeQueue: 消息消费队列、消息到达commitLog后悔异步转发到Queue、</span><br><span class="line">   indexFile: 消息索引文件、主要存储key与<span class="keyword">offset</span>的对应关系</span><br><span class="line">   </span><br><span class="line">   事务状态服务: 存储每条消息的事务状态</span><br><span class="line">   定时消息服务: 每一个延迟级别对应一个消息消费队列、存储延迟队列的消息拉取进度</span><br><span class="line">   </span><br><span class="line"><span class="number">2.</span> msg发送存储流程</span><br><span class="line">   若当前broker挂掉或者broker为slave或者不支持写入时、拒绝写入</span><br><span class="line">   若topic的长度&gt;<span class="number">256</span>个字符、或者msg的属性长度&gt;<span class="number">65535</span>时、拒绝写入</span><br><span class="line">   </span><br><span class="line">   若消息的延迟级别&gt;<span class="number">0</span>, 将消息的原主题名称和原消息队列id存入消息属性、使用延迟消息队列schedule_topic</span><br><span class="line">   </span><br><span class="line">   transientStorePoolEnable 是否开启缓存池. rocketmq单独创建一个mappedByteBuffer内存缓存池、临时存储数据、数据会先写入该内存映射、然后由<span class="keyword">commit</span>线程复制到与物理文件对应的内存映射中、主要是提供一种内存锁定、将当前堆外内存一直锁定在内存中、避免被进程将该内存交互到磁盘、提高存储性能</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="number">3.</span> 存储文件组织与内存映射机制</span><br><span class="line">   doAppend只是将消息存储到byteBuffer中、然后创建AppendMessageResult、只是将消息存储在MappedFile对应的内存映射buffer中、并未刷到磁盘</span><br><span class="line">   handleDiskFlush方法会处理数据持久化</span><br><span class="line">   handleHA会处理m-s</span><br><span class="line">   </span><br><span class="line"><span class="number">4.</span> 存储文件</span><br><span class="line">   commitlog: 消息存储目录</span><br><span class="line">   config运行期间配置信息</span><br><span class="line">   consumequque 消息消费队列存储目录</span><br><span class="line">   <span class="keyword">index</span> 消息索引文件存储目录</span><br><span class="line">   <span class="keyword">abort</span> 启动时创建、正常退出之前删除</span><br><span class="line">   <span class="keyword">checkpoint</span> 文件检测点、存储commitlog文件最后一次刷盘时间戳、consumeQueue最后一次刷盘时间、<span class="keyword">index</span>文件最后一次刷盘时间戳</span><br><span class="line">   </span><br><span class="line"><span class="number">5.</span> 消费队列、索引文件构成和机制</span><br><span class="line"><span class="number">6.</span> 文件恢复机制</span><br><span class="line">   rocketmq将消息全量存储在commitlog中、然后异步转发任务更新consumeQueue、<span class="keyword">index</span>文件、若消息成功存储在commitLog转发任务执行失败、eg. broker宕机、则存储三者不一致的情况、commitlog中的消息可能永远不会被消费、rocketmq是如何保障最终一致性的 ？</span><br><span class="line">   <span class="number">1</span>) 判断上次退出是否正常、在broker启动时<span class="keyword">check</span>是否存储<span class="keyword">abort</span>文件、若存在、说明是非正常退出、需要修复</span><br><span class="line">   <span class="number">2</span>) 加载延迟队列</span><br><span class="line">   <span class="number">3</span>) 加载commitlog文件</span><br><span class="line">   <span class="number">4</span>) 加载消息消费队列</span><br><span class="line">   <span class="number">5</span>) 加载<span class="keyword">checkpoint</span>文件、</span><br><span class="line">   <span class="number">6</span>) 加载索引文件、索引文件上次刷盘时间&lt;该索引文件最大的消息时间戳时 说明索引文件不完备、立即销毁</span><br><span class="line">   <span class="number">7</span>) 根据broker是否正常停止、执行不同的恢复策略</span><br><span class="line">   </span><br><span class="line"><span class="number">7.</span> 刷盘机制</span><br><span class="line">   rocketMQ的刷盘是基于NIO的内存映射机制MappedByteBuffer、消息存储时先将消息追加到内存、再根据配置的刷盘策略在不同时间进行刷写磁盘。</span><br><span class="line">   同步刷盘时: 消息追加到内存后悔同步调用force()方法</span><br><span class="line">   消息生产者将在消息服务器端将消息内容追加到内存映射文件后、需同步将内存内容立刻刷到磁盘、调用内存映射文件MapppedByteBuffer的force方法可将内存中的数据写入磁盘</span><br><span class="line">   </span><br><span class="line">   异步刷盘时: 消息写到内存后、会立即返回给producer、mq单独起一个线程按照固定频率刷盘</span><br><span class="line">   若开启 transientStorePoolEnable机制、RocketMQ会单独申请一个与目标物理文件commitlog相同大小的堆外内存、它将会使用内存锁定、不会被置换到虚拟内存中、消息先追加到堆外内存、然后提交到与物理文件的内存映射内存中、再flush到磁盘</span><br><span class="line">   若未开启transientStorePoolEnable机制、消息直接追加到与物理文件直接映射内存中、然后刷写到磁盘</span><br><span class="line">   <span class="number">1</span>) 先将消息直接追加到ByteBuffer(堆外内存DirectlyByteBuffer), WrotePosition随消息增加不断向后移动</span><br><span class="line">   <span class="number">2</span>) CommiteRealTimeService线程默认每<span class="number">200</span>ms将ByteBuffer中新追加的内容(WritePosition-commitedPosition)提交到MappedByteBuffer中</span><br><span class="line">   <span class="number">3</span>) MappedByteBuffer在内存中追加提交的内存、wrotePosition向前后移动、然后返回</span><br><span class="line">   <span class="number">4</span>) <span class="keyword">commit</span>操作成功返回、将commitedPosition想前后移动本次提交的内容长度、此时wrotePosition指针依然可以向前推进</span><br><span class="line">   <span class="number">5</span>) flushRealTimeService线程默认每<span class="number">500</span>ms将MappedByteBuffer中新追加的内容wrotePosition-上次刷写位置 flushedPositiont通过调研MappedByteBuffer#force方法讲数据刷写到磁盘</span><br><span class="line">   </span><br><span class="line"><span class="number">8.</span> 文件删除机制</span><br><span class="line">   rocketMQ操作commitLog、conssumeQueue是基于内存映射机制并在启动的时候加载commitLog、consumeQueue下所有的文件、为了避免内存与磁盘浪费、引入文件过期机制:</span><br><span class="line">   超过一定时间间隔内没有更新的文件被认为过期文件、默认<span class="number">72</span>h、可通过fileReservedTime来修改</span><br><span class="line">   满足以下条件会删除:</span><br><span class="line">   <span class="number">1</span>) 指定删除文件的时间点、固定时间执行删除 默认凌晨<span class="number">4</span>点</span><br><span class="line">   <span class="number">2</span>) 磁盘不足时、主动触发过期文件删除操作 磁盘分区使用率超过<span class="number">90</span>%不可写入</span><br><span class="line">   <span class="number">3</span>) 预留、手工触发</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mq_rocketMq%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mq_rocketMq%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">rocketMq入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="专业术语"><a href="#专业术语" class="headerlink" title="专业术语"></a>专业术语</h4><ul>
<li><p><code>Producer</code> </p>
<p>消息生产者、负责生产消息、一般由业务系统负责生产消息</p>
</li>
<li><p><code>Consumer</code></p>
<p>消息消费者、负责消费消息、一般由后台系统负责异步消费</p>
<ul>
<li><p><code>Push Consumer</code></p>
<p>Consumer的一种、通常向consumer对象注册一个Listener接口、一旦收到消息、Consumer对象立即回调Listener接口方法</p>
</li>
<li><p><code>Pull Consumer</code></p>
<p>Consumer的一种、应用通常主动调用Consumer的拉取消息放啊从Broker拉取消息、主动权由应用控制</p>
</li>
</ul>
</li>
<li><p><code>Producer Group</code></p>
<p>一类Producer的集合名称、这类Producer通常发送一类消息、且发送逻辑一致</p>
</li>
<li><p><code>Consumer Group</code></p>
<p>一类Consumer的集合名称、消费同一类消息、消费逻辑一致</p>
</li>
<li><p><code>Broker</code></p>
<p>消息中转角色、负责存储消息、转发消息、一般也称为<code>Server</code>、在JMS规范中称为<code>Provider</code></p>
</li>
<li><p><code>广播消费</code></p>
<p>一条消息被多个Consumer消费、即使这些Consumer属于同一个group、可以认为在消息划分方面无意义</p>
</li>
<li><p><code>集群消费</code></p>
<p>一个Consumer Group中的Consumer实例平均分摊消费消息、eg. 某个topic有9条消息、其中一个Consumer Group有3个实例、则 每个实例只消费其中的3条消息</p>
</li>
<li><p><code>顺序消息</code></p>
<p>消费消息的顺序要同发送消息的顺序一致、在RocketMQ中、主要指的是局部顺序、即: 同一类消息为满足顺序性、必须Producer单线程顺序发送、且发送到同一个队列、</p>
</li>
<li><p><code>普通顺序消费</code></p>
</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/14027542-720659236fc9c351.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RocketMQ物理部署结构.png"></p>
<h4 id="RocketMQ网络部署特点"><a href="#RocketMQ网络部署特点" class="headerlink" title="RocketMQ网络部署特点"></a>RocketMQ网络部署特点</h4><ul>
<li><p>NameServer 几乎无状态节点、可集群部署、节点间无任何信息同步</p>
</li>
<li><p>Broker部署相对复杂、分为master和slave、0表示master、非0表示slave、</p>
<p>每个Broker与Name Server集群中的所有节点建立长连接、定时注册Topic信息到所有的Name Server</p>
</li>
<li><p>Producer 与NameServer中的随机一个节点建立长连接、定期从NameServer取topic信息、并向提供topic服务的Master建立长连接、定时向master发送心跳、Producer完全无状态、可集群部署</p>
</li>
<li><p>Consumer与NameServer中随机一个节点建立长连接、从NameServer取topic路由信息、并向提供topic服务的Master、Slave建立长连接、定时向master、slave发送心跳、即可以从master订阅消息、也可以从slave订阅消息</p>
</li>
</ul>
<h4 id="RocketMQ逻辑部署结构"><a href="#RocketMQ逻辑部署结构" class="headerlink" title="RocketMQ逻辑部署结构"></a>RocketMQ逻辑部署结构</h4><p>(<img src="https://upload-images.jianshu.io/upload_images/14027542-0a5961f3b407c08b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="逻辑部署结构.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mysql_Mysql-%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mysql_Mysql-%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84/" class="post-title-link" itemprop="url">Mysql是如何保障高可用的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://upload-images.jianshu.io/upload_images/14027542-242e0ecf16d359cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MySQL主备切换流程.png"></p>
<p>一、主备延迟<br>数据同步的关键时间节点:</p>
<ol>
<li>主库A执行完一个事务、写入binlog、记为 T1;</li>
<li>传给备库B、将备库B接收完binlog的时刻记为 T2;</li>
<li>备库B执行完事务的时刻记为 T3;<br>主备延迟: 同一个事务在备库执行完的时间和主库执行完的时间之间的差值: T3 - T1<br>show slave status; - seconds_behind_master表示当前备库延迟时间</li>
</ol>
<p>注: 主备机的系统时间不一致时、会不会导致主备延迟值不准 ?<br>不会. 备库连接主库时、会通过执行 select unix_timestamp 获得当前主库的系统时间、与本机不一致时、会在执行 seconds_behind_master 时扣除差值</p>
<p>二、主备延迟的来源</p>
<ol>
<li>有些部署条件下、备库所在机器的性能较差<br>此时一般将备库设为<code>非双1模式</code>. 现在一般会使用对称部署(主备规格相同).</li>
<li>使用对称部署、为何仍然存在主备延迟 ?<br>备库可能压力较大、存在一些慢查询、导致备库查询消耗大量CPU资源、影响数据同步、造成主备延迟.<br>解决: <ol>
<li>使用一主多从、分担读压力 </li>
<li>通过binlog输出到外部系统、如: hadoop, 提供统计类查询</li>
</ol>
</li>
<li>采用了一主多从、备库的压力不超过主库的情况下、还有什么情况会导致主备延迟呢 ?<ol>
<li>可能存在大的事务, 因为主库上必须等事务执行完成才会写入binlog、再传给备库、若一个SQL执行10min、这个事务就很可能会导致从库延迟10min.(所以最好不要一次delete太多数据)</li>
<li>大表DDL也是一个大事务的场景</li>
</ol>
</li>
<li>如果备库上也不做大事务了、还有什么原因会导致主备延迟吗 ?<br>备库的并行复制能力.</li>
</ol>
<p>三、主备切换策略:</p>
<ol>
<li><p>可靠性优先.</p>
<ol>
<li>先判断备库B的 seconds_behind_master 是否小于指定值, 若否、持续观察</li>
<li>把主库A改成只读状态, readonly设为true.</li>
<li>判断备库B的 seconds_behind_master 值、直到变为0</li>
<li>把备库B改为可写入, readonly设为false.</li>
<li>将业务请求切到B<br>2~5 的过程、系统处于不可用状态.</li>
</ol>
</li>
<li><p>可用性优先<br>将1中、4)、5) 调整到最开始执行、直接让备库可读写、系统就无不可用时间、但会产生数据不一致. 暂时称为<code>可用性优先策略</code><br>此时若 binlog_format 为: statement、则会发生数据不一致的线下<br>若 binlog_format 为: row、会提示错误</p>
</li>
</ol>
<p>所以、MySQL高可用系统的可用性是依赖于主备延迟的、延迟的时间越小、在主库故障时、服务恢复需要的时间就越短, 可用性就越高.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mysql_MySQL%E6%9C%89%E5%93%AA%E4%BA%9B%60%E9%A5%AE%E9%B8%A9%E6%AD%A2%E6%B8%B4%60%E7%9A%84%E6%8F%90%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mysql_MySQL%E6%9C%89%E5%93%AA%E4%BA%9B%60%E9%A5%AE%E9%B8%A9%E6%AD%A2%E6%B8%B4%60%E7%9A%84%E6%8F%90%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">MySQL有哪些`饮鸩止渴`的提高性能的方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一、短链接风暴<br>正常的短连接模式是连接到数据库后、执行很少的SQL语句就断开、下次需要再重连、若使用的是短连接、在业务高峰期、可能会出现连接数暴涨的情况. MySQL建联的成本是比较高的、除正常的网络三次握手外、还需要登录权限判断和获得这个连接的数据读写权限.</p>
<p>DB压力小时、这些成本并不明显、但DB处理较慢时、连接数就会暴涨、max_connections参数、用来控制一个MySQL实例同时存在的连接数的上限、超过该值、系统会拒绝接下来的连接请求. 此时一个自然的想法是: 调高max_connections的值、但更多请求进来、可能会导致系统的负载进一步变大、大量的资源消耗在鉴权等逻辑上、已经拿到连接的线程拿不到CPU资源去执行请求, 适得其反. </p>
<p>可以怎么做呢 ?</p>
<ol>
<li><p>先处理掉那些占着连接、但不工作的线程.<br>通过kill_connection主动踢掉. 类似提前设置wait_timeout参数(一个线程空闲wait_timeout秒之后、MySQL会主动断开连接)<br>information_schema.innodb_trx 表可以查看事务具体状态.<br>从服务端断开: kill connection + id. 此时Client处于sleep状态、连接被服务端主动断开后、Client不会马上知道、直到Client发起下一个请求, 才会收到 Lost Connection的错误.<br>此时若Client不重新建联、而直接使用原连接重试、会觉得MySQL一直没恢复</p>
</li>
<li><p>减少连接过程的消耗<br>有的业务代码会在短时间内先申请大量数据库连接备用、若现在数据库确认是被连接打挂了、可以先让DB跳过鉴权. 重启DB、使用 –skip-grant-tables 参数启动.<br>但这样MySQL会跳过所有的鉴权、包括连接过程和语句执行过程, 风险极高、尤其是允许外网访问时.<br>Mysql8.0, 跳过鉴权时、会默认打开–skip-networking只允许本地Client可见.</p>
</li>
</ol>
<p>二、慢查询性能问题.<br>可能引发慢查询一般有3种可能:</p>
<ol>
<li><p>索引没设计好</p>
</li>
<li><p>SQL没写好</p>
</li>
<li><p>MySQL选错了索引</p>
</li>
<li><p>索引未设计好、MySQL5.6以后创建索引都支持Online了、一般高峰期DB被SQL打挂时、最高效的做法就是快速添加索引. 若有主备、最高在备库先执行、</p>
</li>
</ol>
<ol>
<li>在备库执行set sql_bin_log&#x3D;off, 关闭binlog写入、执行alter语句添加索引</li>
<li>执行主备切换、</li>
<li>此时主库是B、备库是A、在A上执行 set sql_log_bin&#x3D;off, 执行alter语句添加索引<br>平时做变更时、应考虑 gh-ost 更稳妥、但紧急处理时、上边的方案最高效.</li>
</ol>
<ol start="2">
<li>语句没写好<br>Mysql5.7以上的版本、提供了 query_rewrite 功能、可以将输入的语句改写成另外一种模式.<br>eg. select * from t where id+1&#x3D;10000 会让索引失效、可以通过一个改写语句解决</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> query_rewrite.rewrite_rules(<span class="keyword">pattern</span>, replacement, pattern_database) </span><br><span class="line"><span class="keyword">values</span> (&quot;select * from t where id + 1 = ?&quot;, &quot;select * from t where id = ? - 1&quot;, &quot;db1&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> query_rewrite.flush_rewrite_rules(); <span class="operator">/</span><span class="operator">/</span> 让新插入的规则生效</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>索引没选对、可以通过上线前的SQL分析来提早发现.</li>
</ol>
<p>三、QPS突增问题<br>有时业务突然出现高峰、或者应用程序bug导致某个语句的QPS暴涨、也可能导致MySQL压力过大、影响服务. </p>
<ol>
<li>若是新业务bug导致、且新业务可以下掉、只是时间没那么快、可以直接从DB上把白名单禁掉.</li>
<li>若这个新功能使用的是独立账号、可以将该账号禁用, 这样由它引发的QPS就会降到0</li>
<li>若新功能是跟主体功能部署在一起的、只能通过处理语句来限制, 可以使用上边的重写功能、将压力最大的SQL重写为 select 1.<br>当然该操作的风险很高、它可能导致:</li>
<li>若别的功能也用到了该SQL、会被误伤</li>
<li>很多业务不是靠一个SQL就完成逻辑的、这样会导致后边的业务一起失败.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/mysql_Mysql-%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="niuniu">
      <meta itemprop="description" content="多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="牛牛的小窝">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/20/mysql_Mysql-%E6%98%AF%E6%80%8E%E4%B9%88%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%A2%E7%9A%84/" class="post-title-link" itemprop="url">Mysql是怎么保证数据不丢的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-20T00:00:00+08:00">2020-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-07 11:31:06" itemprop="dateModified" datetime="2022-05-07T11:31:06+08:00">2022-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://upload-images.jianshu.io/upload_images/14027542-56a40a40793fd005.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/440" alt="binlog写盘状态.png"></p>
<p>一、binlog的写入机制</p>
<ol>
<li>binlog写入逻辑: <ol>
<li>事务执行过程中、先写日志导binlog cache、事务提交时、再把binlog cache写入到binlog文件中.</li>
<li>一个事务的binlog不能被拆开、因此不论事务有多大、也要确保一次性写入. 系统给binlog cache每个线程分配一片内存(binlog_cache_size大小), 超过会先暂存到磁盘.</li>
<li>事务提交时、执行器会把binlog cache里的完整事务写入binlog、清空binlog cache.</li>
</ol>
</li>
<li>每个线程有自己的binlog cache、但共用binlog文件.<br>事务提交、先写入到文件系统的page cache(write), 然后调用fsync写入磁盘(占用IOPS)<br>write和fsync的时机:<br>sync_binlog&#x3D;0, 每次事务提交只write、不fsync<br>sync_binlog&#x3D;1, 每次事务提交都执行fsync<br>sync_binlog&#x3D;N, 每次事务提交都write、累积N个事务才fsync<br>所以、在出现IO瓶颈的场景里、可以将sync_binlog设置为一个比较大的值、可以提升性能.<br>风险: 若主机异常重启、会丢失最近N个事务的binlog.</li>
</ol>
<p>二、redo log的写入机制<br>事务执行过程中会先写redo log buffer, 然后才写redo log<br><img src="https://upload-images.jianshu.io/upload_images/14027542-c93a7e2e48dc724e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="redo log存储状态.png"><br>从redo log的三种状态说起:</p>
<ol>
<li>存在redo log buffer中、物理上是在 mysql 进程内存中.</li>
<li>写到磁盘write、但未持久化fsync、物理上是在文件系统的Page Cache中</li>
<li>持久化到磁盘</li>
</ol>
<p>1、2的过程都很快、但3的速度就慢很多了. InnoDB提供了三种策略, 通过 innodb_flush_log_at_trx_commit参数控制:</p>
<ol>
<li>0, 表示每次事务提交只把redo log留在redo log buffer中</li>
<li>1, 表示每次事务提交都将redo log直接持久化到磁盘</li>
<li>2, 表示每次事务提交都把redo log写到Page Cache.<br>InnoDB 有一个后台线程、每隔1s、会把redo log buffer中的日志调用write写到FS Pae Cache、然后调用 fsync 持久化到磁盘.</li>
</ol>
<p>注意: 事务执行过程中的redo log也是在buffer中、可能会被后台线程一起持久化到磁盘<br>还有两种场景会将一个未提交的事务redo log写入磁盘:</p>
<ol>
<li>redo log buffer占用的空间即将达到innodb_log_buffer_size 一半的时候、后台线程会主动写盘. (此时事务未提交、只是write、并未fsync, 即: 只留在FS Page Cache)</li>
<li>并行事务提交时, 顺带将该事务的 redo log buffer持久化到磁盘、eg. Trx A执行到一半、Trx B要把buffer数据写入磁盘、会顺带把Trx A的日志一起持久化到磁盘<br>注意: 若将 innodb_flush_log_at_trx_commit 设为1, redo log在prepare阶段就要持久化一次、因为有一个崩溃恢复依赖于prepare的redo log + binlog.<br>通常说的<code>双1</code>配置、是redo log 和binlog的刷盘机制都设为1, 即: 一个事务完整提交前、需要等待两次刷盘: redo log(prepare阶段) 和 binlog</li>
</ol>
<p>思考: TPS 2w&#x2F;s 的话、写盘就是 4w&#x2F;s, 但磁盘能力只有2w&#x2F;s, 是怎么实现的呢 ?<br>组提交: 三个并发事务trx1, trx2, trx3, 对应LSN(日志逻辑序列化、单调递增)分别为:50, 120, 160, trx1写盘时、这组(trx1-&gt;3)已经有3个事务、LSN也变成了160, 去写盘时、带的LSN&#x3D;160, 等trx1返回时、所有LSN&lt;160的redo log都已持久化到磁盘, trx2,trx3可直接返回.<br><img src="https://upload-images.jianshu.io/upload_images/14027542-1044eab2470e5e22.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240" alt="两阶段提交细化.png"></p>
<p>在并发更新场景下、第一个事务写完 redo log buffer、调用fsync越晚、组员越多、节约IOPS效果越好.<br>binlog的write 和 fsync的时间间隔短、组提交优化不如redo log.<br>可以通过设置以下参数来提升效果:</p>
<ol>
<li>binlog_group_commit_sync_delay, 延迟x 微秒后才调用fsync</li>
<li>binlog_group_commit_sync_no_delay_count, 累积x次以后调用fsync<br>二者满足其一就调用 fsync</li>
</ol>
<p>另: 不建议设置 innodb_flush_log_at_trx_commit&#x3D;0, 因为这样redo log只保存在内存中、MySQL异常重启会丢失数据、风险太大. 而redo log写到 FS Page Cache的速度也是很快的、不会损失很多性能, 可以保证异常重启不丢数据、风险小很多.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">niuniu</p>
  <div class="site-description" itemprop="description">多数是学习笔记、偶尔发发感慨、给生活添加些许乐趣</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">162</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">niuniu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
